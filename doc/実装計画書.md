了解です。要件定義を踏まえた **実装計画書（v1）** をまとめました。
（ポイント：**Infura の RPC URL / パス類はリポジトリ内に平文で残さない**／公開 GitHub リポで同期）

---

# 実装計画書（v1）— ガス代ワンテーブル比較ツール

## 0. ゴール

* ローカルの静的ホスト（Nginx 等）でフロントを配信。
* バックエンド（同一ホスト内の API サービス）が Infura 経由で各チェーンの **Gas Price（Gwei）** を取得し、**ネイティブ送金 1 回の概算手数料**を返す。
* **ETH / POL(Polygon PoS) / ARB / OP / AVAX(C-Chain) / LINEA** を横並び表示。
* **公開リポ**でコードを管理するが、**Infura の URL やキー等が平文で repo に載らない**。

---

## 1. 技術スタック & 方針

### バックエンド

* 言語/フレームワーク：**Python 3.11 + FastAPI**（軽量・型サポート・レスポンス高速）
* HTTP クライアント：`httpx`（非同期対応）
* キャッシュ：アプリ内メモリ（TTL 600 秒 ≒ 10 分）／将来 Redis 切替可
* テスト：`pytest` + `pytest-asyncio`
* 目的：RPC 集約、手数料計算、価格換算（任意）

### フロント

* ビルド：**Vite + TypeScript**（SPA でも MPA でも可、軽量）
* UI：素の TS/HTML か、必要に応じて軽量 UI（例：Preact）
* 表示：1 ページ、テーブル 1 枚、操作系（Action/Mode/Fiat/GasUsed）

### 配信／ランタイム

* **Nginx**（`/`＝静的、`/api`＝バックエンドへリバプロ）
* **Docker Compose** で起動（frontend + api + nginx）
* バックエンドは **localhost バインド**（例：127.0.0.1:9000）。外部へは Nginx 経由のみ

---

## 2. ディレクトリ構成（公開リポ）

```
repo-root/
  frontend/                # 静的フロント（Vite）
    src/
    index.html
    vite.config.ts
  backend/
    app/
      __init__.py
      main.py              # FastAPI エントリ
      config.py            # 設定・ENV 読み込み
      chains.py            # チェーン定義・型
      rpc.py               # RPC 呼び出し（Infura）
      fees.py              # ガス計算ロジック
      cache.py             # TTL キャッシュ
      routers/
        fees.py            # /fees エンドポイント
        health.py          # /health
      tests/
        test_fees.py
        test_rpc.py
    pyproject.toml
  deploy/
    nginx.conf             # リバプロ設定（API パスはここで決める）
    docker-compose.yml     # env_file 指定のみ。値は別ファイル
  .env.example             # ダミー値（キー/URL はダミー or 空）
  .gitignore
  README.md
```

> **重要**：実値入りの `.env` は **コミット禁止**。運用ホストにのみ配置。

---

## 3. シークレット／設定管理（平文化しない）

### 3.1 何を秘匿するか

* **Infura のプロジェクト ID / RPC URL**（ネットワーク別）
* 任意：価格 API キー（使う場合）

### 3.2 どうやって隠すか

* **ENV 導入**：バックエンドは **すべての上流 URL を ENV から受け取る**（コードに文字列定数を置かない）

  * `INFURA_RPC_URLS_JSON`（JSON 文字列／各チェーンのベース URL をキー付きで格納）
  * `INFURA_PROJECT_ID`（ID だけ別 ENV にして URL を実行時に合成しても OK）
* **運用ホスト上の .env**：

  * `deploy/.env.local` を **サーバーにだけ置く**（`.gitignore` 済）
  * `docker-compose.yml` は `env_file: ["./.env.local"]` のみ参照
* **オプション（暗号化したい場合）**：

  * **SOPS + age** で `deploy/secrets.enc.yaml` を repo に置く（復号鍵は運用ホストだけ）。
  * デプロイ時に `make secrets:decrypt` で `.env.local` を生成。
  * これにより **repo には常に暗号化ファイルのみ** が存在。

### 3.3 ログ・ダンプ対策

* バックエンドのリクエスト/レスポンスログに **URL / キーを出さない**。
* 例外時も **エンドポイント文字列のマスキング**（`.../v3/<redacted>`）。

---

## 4. API 設計（ローカル公開用）

### 4.1 エンドポイント（バックエンド内）

* `GET /fees`

  * `mode`: `standard` | `precise`（既定 `standard`）
  * `action`: `native` | `erc20`（既定 `native`）
  * `gasUsed`: number（未指定時 `native=21000` / `erc20=55000`）
  * `fiat`: `none` | `usd` | `jpy`（既定 `none`）
* `GET /health`（ヘルスチェック）

> **注**：**対外的な API パス（例：`/api/fees`）は Nginx 側で決定**。バックエンドは `/fees` でリッスンし、Nginx で `/api` を付与する（コード中に公開パス文字列を埋めない）。

---

## 5. 実装詳細

### 5.1 チェーン定義（コード上は ID/記号のみ）

* コードにはチェーンの **論理名/ID/シンボル**のみ保持：

  ```python
  CHAINS = [
    {"key":"ETH",   "chain_id":1,     "symbol":"ETH"},
    {"key":"POL",   "chain_id":137,   "symbol":"POL"},  # 表示は POL（MATIC 注記可）
    {"key":"ARB",   "chain_id":42161, "symbol":"ETH"},
    {"key":"OP",    "chain_id":10,    "symbol":"ETH"},
    {"key":"AVAX",  "chain_id":43114, "symbol":"AVAX"},
    {"key":"LINEA", "chain_id":59144, "symbol":"ETH"},
  ]
  ```
* **ベース URL** は `INFURA_RPC_URLS_JSON` にて提供（例は「6. サンプル ENV」参照）。

### 5.2 Gas 取得（standard）

1. `eth_feeHistory(5, "latest", [50])` → `baseFeePerGas`
2. `rewardPercentiles=[p]`（既定 `p=50`=MetaMask Medium）を指定し、`reward` から推奨 tip を抽出（欠損時のみ `eth_maxPriorityFeePerGas` を呼ぶ）
3. `gasPriceWei = baseFee + priority`（失敗時 `eth_gasPrice`）
4. `gasGwei = gasPriceWei / 1e9`
5. `fee_native = gasGwei / 1e9 * gasUsed`
6. ERC‑20 (WBTC) 送金は `gas_used = chain.erc20_gas_limit`（既定 55,000）で同単価を適用
7. 任意：CoinMarketCap API で USD/JPY へ換算（`fiat=usd|jpy`）

### 5.3 Gas 取得（precise β）

* **OP**：L1 データ料金を GasPriceOracle から取得し加算（送金 tx の最小 RLP を内部合成）
* **ARB**：`eth_estimateGas × eth_gasPrice` を採用（失敗時 standard）

> 初期リリースでは **standard を既定**、precise をオプション。

### 5.4 キャッシュ

* チェーン別結果を **TTL 600 秒 (10 分)** で記憶し、「最新に更新」ボタン押下時は強制再取得。
* 429/5xx などの一時的失敗時は **0.5s→1.0s の指数バックオフ**で最大 3 回リトライ。
* それでも失敗した場合は直近成功値を `stale` として返し、UI で「Stale」バッジを表示（API には `stale: true` が付与される）。

### 5.5 フロント

* 起動時とユーザ操作（手動更新・間隔変更）で `/api/fees?...` を叩く。
* テーブル列：Chain / Gas(Gwei) / GasUsed / Fee(native) / Fee(USD|JPY) / ERC20 Gas / ERC20 Fee
* `/fees/?format=html` では JPY を既定表示とし、トグルから `USD`／`JPY` を切り替えて CoinMarketCap 由来の価格を表示（価格は 1 時間キャッシュ、更新ボタンで強制再取得）。ERC-20 手数料は WBTC 送金を基準に概算する。
* 並び替え（Gwei 昇順など）・コピー機能（行/全体）

---

## 6. サンプル ENV（**コミット禁止**の `.env.local` 例）

> **注意**：以下は例。実値は運用ホストのみで保持し、repo には `.env.example`（空/ダミー）だけを置く。

```
# backend 用
APP_BIND_HOST=127.0.0.1
APP_BIND_PORT=9000
CACHE_TTL_SECONDS=600

# Infura
INFURA_PROJECT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# 各チェーンのベース URL 群（コードに平文で持たない）
# プロジェクト ID はコード側で連結して最終 URL を作る（必要ならこの JSON に含めてもOK）
INFURA_RPC_URLS_JSON={
  "ETH":   "https://mainnet.infura.io/v3",
  "POL":   "https://polygon-mainnet.infura.io/v3",
  "ARB":   "https://arbitrum-mainnet.infura.io/v3",
  "OP":    "https://optimism-mainnet.infura.io/v3",
  "AVAX":  "https://avalanche-mainnet.infura.io/v3",
  "LINEA": "https://linea-mainnet.infura.io/v3"
}

# 価格換算（任意）
COINMARKETCAP_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PRICE_CACHE_TTL_SECONDS=3600
COINMARKETCAP_API_URL=https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest
FEE_HISTORY_REWARD_PERCENTILE=50
```

> **ログ抑制**：アプリは上記 ENV の **値を絶対に出力しない**（`config.py` で redaction）。

---

## 7. Nginx／Compose（骨子）

**deploy/docker-compose.yml（骨子）**

```yaml
version: "3.9"
services:
  api:
    build: ./backend
    env_file:
      - ./.env.local
    ports:
      - "127.0.0.1:9000:9000"   # ローカルバインド
    restart: unless-stopped

  frontend:
    build: ./frontend
    restart: unless-stopped

  nginx:
    image: nginx:1.27
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    ports:
      - "80:80"
    depends_on:
      - api
      - frontend
```

**deploy/nginx.conf（骨子）**

```nginx
events {}
http {
  server {
    listen 80;
    # 静的
    location / {
      root /usr/share/nginx/html;
      try_files $uri /index.html;
    }
    # API（外部の見かけは /api、バックエンドは /fees 等）
    location /api/ {
      proxy_pass http://api:9000/;  # 末尾の / に注意
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }
}
```

> これにより **公開パス `/api/fees` は Nginx のみが知り、バックエンド側ソースに固定文字列を持たせない**。

---

## 8. 実装タスク分解

### P0（最小）

1. **backend** scaffold（FastAPI・設定読込・/fees・/health）
2. `rpc.py`：Infura RPC 呼び出し（feeHistory / priority / gasPrice フォールバック）
3. `fees.py`：概算計算（native=21k / erc20=55k）
4. メモリキャッシュ（キー：`mode+action` とチェーン）
5. フロント最小 UI（表、設定パネル、手動更新）
6. Nginx + Compose 起動、LAN から閲覧

### P1（改善）

1. `precise` モード（OP: L1 料算出、ARB: estimateGas 反映）
2. 価格換算（USD/JPY）＋ TTL 120s
3. エラーバッジ／最終更新時刻表示／コピー

### P2（運用）

1. ログ整備（遅延>2s、429、タイムアウト）
2. Basic 認証（Nginx）または IP 制限（任意）
3. CI（lint/test/build）＋ secret スキャン（`gitleaks`）

---

## 9. テスト計画

* **ユニット**：

  * fee 計算（wei↔gwei、gasUsed 変更、丸め）
  * `eth_feeHistory` / `eth_maxPriorityFeePerGas` レスポンスのモック → 期待値
* **結合**：

  * 各チェーン 6 行が返ること
  * fallback 動作（`eth_feeHistory` 失敗 → `eth_gasPrice`）
  * キャッシュ TTL（連続呼び出しで RPC 回数が増えない）
* **E2E**（ブラウザ）：

  * UI 初期表示、更新、ソート、Fiat 切替
  * エラー時の Stale 表示

---

## 10. セキュリティ／運用注意

* **キーはバックエンドのみ**、フロントへ渡さない（CORS 同一オリジン、API はローカルのみ公開）
* **ログに秘密を出さない**（URL・ヘッダ・ENV の redaction）
* 依存ライブラリの脆弱性監査（`pip-audit` / `npm audit`）
* 429/5xx の指数バックオフ（チェーン別）

---

## 11. リスクと対応

* **L2 の L1 データ料**は tx サイズ依存でブレる → precise は「近似」で表示し注記
* **Infura レート制限** → TTL キャッシュ必須、リフレッシュ間隔の下限（例：30s）を UI に
* **Polygon の表記（POL/MATIC）** → UI で注記（`POL（旧MATIC）`）

---

## 12. 受け入れ条件（抜粋）

* `/api/fees?action=native&mode=standard` が 6 チェーン分の行を<1sで返す（キャッシュ命中時）
* 例外時でも 200 + `stale: true` と最終更新時刻を返し、UI に Stale バッジ
* リポに **実値の URL/キーが一切含まれない**（文字列検索でも出てこない）

---

## 13. すぐ使える最小コード断片（要点のみ）

**backend/app/config.py（ENV のみから設定を読み込み・秘匿）**

```python
from pydantic import BaseModel
import json, os

class Settings(BaseModel):
    bind_host: str = os.getenv("APP_BIND_HOST", "127.0.0.1")
    bind_port: int = int(os.getenv("APP_BIND_PORT", "9000"))
    cache_ttl: int = int(os.getenv("CACHE_TTL_SECONDS", "60"))
    infura_project_id: str = os.environ["INFURA_PROJECT_ID"]
    rpc_base_urls: dict[str,str] = json.loads(os.environ["INFURA_RPC_URLS_JSON"])

    def rpc_url(self, chain_key: str) -> str:
        base = self.rpc_base_urls[chain_key].rstrip("/")
        return f"{base}/{self.infura_project_id}"

settings = Settings()
```

**backend/app/rpc.py（RPC 呼び出し骨子：URL は config からのみ）**

```python
import httpx, asyncio
from .config import settings

async def call_rpc(chain_key: str, method: str, params: list):
    url = settings.rpc_url(chain_key)
    payload = {"jsonrpc":"2.0","id":1,"method":method,"params":params}
    async with httpx.AsyncClient(timeout=5.0) as client:
        r = await client.post(url, json=payload)
        r.raise_for_status()
        return r.json()["result"]
```

> ※ 実コードでは例外処理・マスキング・バックオフ等を追加。

---

以上です。
この計画に沿って **P0 実装（最小構成）** のコード一式（Docker 含む）まで出力できます。必要なら続けて **雛形のリポ構成＆ファイル一式** を提示します。
