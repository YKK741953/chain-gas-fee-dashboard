以下は、あなたの方針（**自前サーバーで開発・ローカルで静的ホスト公開／Infuraで各チェーンのGwei取得／対象: ETH, POL(Polygon PoS), ARB, OP, AVAX(C-Chain), LINEA**）に基づく **要件定義書** です。必要十分にミニマムで始めて、後から精度モードを拡張できる構成にしています。

---

# ガス代ワンテーブル比較ツール 要件定義書（v1）

## 1. 目的

主要EVM/L2チェーン（ETH, Polygon PoS, Arbitrum One, OP Mainnet, Avalanche C-Chain, Linea）について、**「基軸通貨（ネイティブトークン）を1回送金するときの手数料」を一目で比較**できる、軽量なローカルWebツールを提供する。
手数料は **Gwei（Gas Price）→ ネイティブ通貨 →（任意で法定通貨）**の順に概算する。

> 注: Polygon PoS のネイティブは 2024年以降 **MATIC → POL** へ移行済み（表示名ゆらぎに注意）。公式アナウンスに準拠します。 ([Polygon][1])

---

## 2. スコープ

* **対象チェーン**：Ethereum Mainnet、Polygon PoS（POL）、Arbitrum One、OP Mainnet、Avalanche C-Chain、Linea。
* **対象アクション**：

  * **必須**：ネイティブ送金（native transfer）
  * **任意（将来拡張）**：ERC‑20送金（概算）
* **表示**：テーブル1枚で比較（チェーン横並び）。

---

## 3. 前提・用語

* **Gas Price（Gwei）**：各チェーンの推奨単価をRPCから取得。

  * EIP‑1559系では `baseFee + priorityFee` に基づく推定を採用し、`eth_feeHistory` と `eth_maxPriorityFeePerGas` を優先、失敗時は `eth_gasPrice` にフォールバック。 ([MetaMask][2])
* **概算手数料（ネイティブ）**：

  $$
  \text{fee(native)} = \frac{\text{gasPrice(Gwei)}}{10^9} \times \text{gasUsed}
  $$

  （ネイティブ送金は基本 **21,000 gas** を使用）
* **L2特性**：

  * **Optimism** は **L1データ料金**が別途存在。厳密には GasPriceOracle の `getL1Fee(rlpTx)` 等で算出する（精度モードで対応）。 ([Optimism Docs][3])
  * **Arbitrum** は `eth_estimateGas × eth_gasPrice` が**総必要額**の良い近似になる設計。まずは標準モードで21,000固定、精度モードで `eth_estimateGas` に切替。 ([Arbitrum Docs][4])
* **金額換算（任意）**：USD/JPY等は CoinGecko の Simple Price API等で取得（キャッシュ前提）。 ([CoinGecko API][5])

---

## 4. ユースケース

* ローカルLAN内で常時表示し、**主要チェーンの手数料感を即把握**。
* 送金規模にかかわらず**1回あたりの手数料比較**（送金額は手数料に無関係）。

---

## 5. 機能要件

### 5.1 表示/UI

* 単一ページ（静的）。上部に設定、下部に比較テーブル。
* **テーブル列**（固定）

  1. Chain
  2. Gas Price (Gwei)
  3. Gas Used（既定: 21,000／編集可）
  4. Fee (native)
  5. Fee (USD/JPY) ※任意トグル
* **設定項目**

  * 更新間隔（例: 30/60/120秒）
  * 精度モード：**標準**（速い・軽い）／**精度（β）**（OP/ARBのL1データ料やestimateGasを考慮）
  * アクション種別：**Native**／ERC‑20（既定gasUsed=55,000、編集可）

### 5.2 データ取得・計算（標準モード）

* チェーンごとに以下を実行：

  1. `eth_feeHistory(5, "latest", [50])` で直近ブロックの **baseFee** を取得
  2. `eth_maxPriorityFeePerGas` で推奨 **priorityFee** を取得
  3. `gasPrice = baseFee + priorityFee`（wei → Gwei換算）
  4. `fee(native) = gasPrice(Gwei)/1e9 * gasUsed`
  5. （任意）シンボル別に CoinGecko で USD/JPY 変換
     ※ フォールバック：`eth_gasPrice` 使用。 ([MetaMask][2])

### 5.3 データ取得・計算（精度モード β）

* **Optimism**：`gasPrice`に加え、GasPriceOracle の `getL1Fee(serializedTx)` または `eth_estimateL1Fee` で L1データ料を取得して加算（送金txの簡易RLP生成を内部で実施）。 ([Optimism Docs][3])
* **Arbitrum**：`eth_estimateGas` と `eth_gasPrice` を併用し、**総額 ≒ estimateGas × gasPrice**。失敗時は標準モードにフォールバック。 ([Arbitrum Docs][4])

### 5.4 キャッシュ

* **バックエンド側**でチェーン別結果を **60秒TTL** でキャッシュ。
* CoinGeckoはAPI側も1–5分キャッシュがあるため、60–120秒程度で十分。 ([CoinGecko][6])

### 5.5 エラーハンドリング

* RPC・価格APIの失敗時：直近キャッシュ表示＋「最終更新時刻」を強調。
* チェーン個別障害時：該当行のみ “retry in …s” バッジ。

### 5.6 ログ

* 取得失敗／遅延（>2s）／429等のステータスをJSONでロギング（回数・チェーン別）。

---

## 6. 非機能要件

### 6.1 セキュリティ

* **Infura APIキー**はバックエンドの環境変数に保持（フロントに埋め込まない）。

  * Infuraキーは**エンドポイント単位**で提供（HTTPS/WS）し、公式の**エンドポイント**を使用。 ([MetaMask][7])
  * 参考：メソッドごとの課金・レートは**Credits制**。過剰呼び出し防止にキャッシュ必須。 ([Infura][8])
* ローカル公開（LAN）でのCORSは **同一オリジン**に統一（Nginxで `/api` をバックエンドにリバースプロキシ）。CORS周りの一般的注意点はInfuraヘルプに準拠。 ([support.infura.io][9])

### 6.2 可用性・性能

* バックエンド1プロセスで十分（同時接続<数十）。
* 1リフレッシュで各チェーンに最大2–3RPC（feeHistory/priorityPrice/fallback）を許容。

### 6.3 運用

* `.env` でAPIキー管理、`.env.example` を同梱。
* Docker起動 or systemdで常駐。

---

## 7. システム構成（提案）

```
[Browser (静的UI)]
  |
  |  GET /api/fees?mode=standard|precise&action=native|erc20
  v
[Backend: aggregator API (FastAPI or Node/Express)]
  |- calls Infura RPC per chain
  |- optional: CoinGecko Simple Price
  |- 60s in-memory cache
  v
[Infura RPC endpoints]   [CoinGecko Simple Price API]
```

* **フロント（静的）**：Vite + TypeScript + （任意で）Tailwind。
* **バックエンド**：Python(FastAPI) or Node(Express)。
* **配信**：Nginxで `/`→静的UI、`/api/*`→バックエンド。

---

## 8. 外部依存関係

### 8.1 Infura エンドポイント（Mainnet）

* **Ethereum**：`https://mainnet.infura.io/v3/<API_KEY>` ([MetaMask][7])
* **Polygon PoS**：`https://polygon-mainnet.infura.io/v3/<API_KEY>`（表示はPOL） ([MetaMask][10])
* **Arbitrum One**：`https://arbitrum-mainnet.infura.io/v3/<API_KEY>` ([MetaMask][7])
* **OP Mainnet**：`https://optimism-mainnet.infura.io/v3/<API_KEY>` ([MetaMask][11])
* **Avalanche C-Chain**：`https://avalanche-mainnet.infura.io/v3/<API_KEY>` ([MetaMask][12])
* **Linea**：`https://linea-mainnet.infura.io/v3/<API_KEY>` ([docs.linea.build][13])

### 8.2 RPCメソッド

* **標準モード**：`eth_feeHistory`、`eth_maxPriorityFeePerGas`、（fallback）`eth_gasPrice`。 ([MetaMask][2])
* **精度モード**：

  * OP：GasPriceOracle `getL1Fee(serializedTx)` または `eth_estimateL1Fee`。 ([Optimism Docs][3])
  * ARB：`eth_estimateGas` と `eth_gasPrice` の組合せ。 ([Arbitrum Docs][4])

### 8.3 価格API（任意）

* **CoinGecko Simple Price**：`/simple/price?ids=ethereum,polygon-...&vs_currencies=usd,jpy`（1–5分キャッシュ） ([CoinGecko API][5])

---

## 9. チェーン基本情報（参照）

* **Chain IDs**：ETH=1、Polygon PoS=137、Arbitrum One=42161、OP=10、Avalanche C‑Chain=43114、Linea=59144。 ([ChainList][14])

---

## 10. API I/F 仕様（バックエンド）

### 10.1 `GET /api/fees`

**Query**

* `mode`: `standard` | `precise`（既定: `standard`）
* `action`: `native` | `erc20`（既定: `native`）
* `gasUsed`: number（任意。未指定時は native=21000 / erc20=55000）
* `fiat`: `none` | `usd` | `jpy`（既定: `none`）

**Response（例）**

```json
{
  "updatedAt": "2025-09-26T06:30:00Z",
  "action": "native",
  "mode": "standard",
  "rows": [
    {"chain":"ETH","symbol":"ETH","gasGwei":8.7,"gasUsed":21000,"feeNative":0.0001827,"feeUSD":0.58},
    {"chain":"POL","symbol":"POL","gasGwei":33.1,"gasUsed":21000,"feeNative":0.0006951,"feeUSD":0.01},
    {"chain":"ARB","symbol":"ETH","gasGwei":0.14,"gasUsed":21000,"feeNative":0.00000294},
    {"chain":"OP","symbol":"ETH","gasGwei":0.34,"gasUsed":21000,"feeNative":0.00000714},
    {"chain":"AVAX","symbol":"AVAX","gasGwei":25.0,"gasUsed":21000,"feeNative":0.000525},
    {"chain":"LINEA","symbol":"ETH","gasGwei":0.3,"gasUsed":21000,"feeNative":0.0000063}
  ]
}
```

> ※数値は例。OP/ARBは `precise` でL1データ料を含めた総額を返す。

---

## 11. 精度方針

* **標準モード**：

  * 全チェーン共通で **EIP‑1559推定（baseFee+priority）** or `eth_gasPrice` による**即時・安定**な概算。 ([MetaMask][2])
* **精度モード（β）**：

  * **OP**：`getL1Fee` / `eth_estimateL1Fee` を加算。送金txのRLPは内部生成（固定nonce/chainId/ガス上限の安全値で計算）。 ([Optimism Docs][3])
  * **ARB**：`eth_estimateGas × eth_gasPrice` を採用（ドキュメント推奨）。 ([Arbitrum Docs][4])

---

## 12. 既定値・パラメータ

* `gasUsed` 既定：**native=21,000**／**erc20=55,000**（編集可）
* 更新間隔：既定 **60秒**
* 価格通貨：既定 **無効**（`fiat=none`）。必要時にUSD/JPY。

---

## 13. UI仕様（詳細）

* 上部バー：

  * [Action: Native / ERC20] [Mode: Standard / Precise(β)] [GasUsed: 数値入力] [Fiat: None/USD/JPY] [Interval: 30/60/120s] [手動更新]
* テーブル：チェーンを **ETH / ARB / OP / POL / AVAX / LINEA** の順で表示（並び替えトグル可）。
* セル表示例：`0.0001827 ETH ($0.58)` のようにネイティブ優先、法定は括弧。

---

## 14. エラー表示

* ヘッダー右に `Last updated: 06:30:00`。エラー時は赤色で `Stale (02:10)`。
* 行単位で `RPC error (429)` 等の簡潔メッセージ。

---

## 15. 運用・デプロイ

* **ローカルxubuntuサーバー**想定。
* Docker Compose例：

  * `frontend`（静的ビルド→Nginxで配信）
  * `api`（FastAPI/Express）
  * Nginxで `/`→frontend、`/api`→api
* Infura **API Key** は `api` の環境変数に設定（キーはダッシュボードで各ネットワークを有効化）。 ([MetaMask][7])

---

## 16. 受け入れ基準（サンプル）

1. ローカルで `/` を開くと、全6チェーンの行が **1秒以内にキャッシュ命中**で描画される。
2. `mode=precise` で OP/ARB の手数料が標準モードより**わずかに増額**（L1データ料反映）が確認できる。 ([Optimism Docs][3])
3. 価格APIを有効化すると USD/JPY 列が表示され、**更新間隔に従って**更新される（CoinGeckoのキャッシュ仕様範囲内）。 ([CoinGecko][6])

---

## 17. リスク・留意点

* **L2のL1データ料**はトランザクションサイズに依存し、**完全一致の事前推定は困難**。精度モードでもごく小さい乖離は許容。 ([Optimism Docs][15])
* Infuraは**クレジット制限**があるため、**キャッシュ必須**。高頻度ポーリングは避ける。 ([Infura][8])
* Polygonは**表示名（MATIC/POL）にゆらぎ**が残る可能性（外部UI/ウォレット）。UIでは **POL（MATIC）** と注記。 ([Polygon][1])

---

## 付録A：参考エンドポイントと例

### A-1. Infura（例：Avalanche C-Chain）

```
POST https://avalanche-mainnet.infura.io/v3/<API_KEY>
{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}
```

（MetaMask/Infura公式クイックスタートに明記） ([MetaMask][12])

### A-2. `eth_feeHistory`（概要）

* 直近ブロックの `baseFeePerGas` を取得して傾向把握。 ([MetaMask][2])

### A-3. Optimism L1データ料（概念）

* GasPriceOracle `getL1Fee(serializedTx)` を用いる。 ([Optimism Docs][3])

### A-4. Arbitrum 手数料の全体把握

* `eth_estimateGas × eth_gasPrice` ≒ 必要ETH総額。 ([Arbitrum Docs][4])

---

# 次アクション（提案）

* この要件でOKなら、**設計（API I/F詳細・ディレクトリ構成）**と、**最小実装（Docker Compose含む）**をまとめて出します。

  * 例：FastAPIバックエンド＋Viteフロントの最小コード一式。

必要なら**精度モード（OP/ARB）**から先に入れて出すこともできます。

[1]: https://polygon.technology/blog/matic-to-pol-migration-is-now-live-everything-you-need-to-know?utm_source=chatgpt.com "MATIC to POL Migration Is Now Live"
[2]: https://docs.metamask.io/services/reference/ethereum/json-rpc-methods/eth_feehistory/?utm_source=chatgpt.com "Ethereum eth_feeHistory"
[3]: https://docs.optimism.io/app-developers/transactions/estimates?utm_source=chatgpt.com "Estimating transaction fees on OP Mainnet"
[4]: https://docs.arbitrum.io/how-arbitrum-works/gas-fees?utm_source=chatgpt.com "Gas and Fees"
[5]: https://docs.coingecko.com/reference/simple-price?utm_source=chatgpt.com "Coin Price by IDs - CoinGecko API"
[6]: https://www.coingecko.com/en/api/pricing?utm_source=chatgpt.com "Crypto API Pricing Plans - CoinGecko"
[7]: https://docs.metamask.io/services/get-started/endpoints/ "All endpoints | MetaMask developer documentation"
[8]: https://www.infura.io/pricing?utm_source=chatgpt.com "Infura Pricing"
[9]: https://support.infura.io/building-with-infura/general-knowledge/cors?utm_source=chatgpt.com "CORS (Cross Origin Resource Sharing) | Infura Help Center"
[10]: https://docs.metamask.io/services/reference/polygon-pos/quickstart/ "Polygon PoS quickstart | MetaMask developer documentation"
[11]: https://docs.metamask.io/services/reference/optimism/quickstart/ "Optimism quickstart | MetaMask developer documentation"
[12]: https://docs.metamask.io/services/reference/avalanche-c-chain/quickstart/ "Avalanche (C-Chain) quickstart | MetaMask developer documentation"
[13]: https://docs.linea.build/api/reference "Use the Linea API | Linea"
[14]: https://chainlist.org/chain/137?utm_source=chatgpt.com "Polygon Mainnet RPC and Chain settings"
[15]: https://docs.optimism.io/stack/transactions/fees?utm_source=chatgpt.com "Transaction fees on OP Mainnet"
